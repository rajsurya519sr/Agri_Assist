{% extends "base.html" %}

{% block title %}{{ _('My Farms') }} - {{ _('AgriAssist') }}{% endblock %}

{% block content %}
<style>
    /* --- Page Layout & Theme --- */
    body {
        background-image: linear-gradient(to right, white, #1B5E20);
        background-attachment: fixed;
    }

    .main-title {
        color: #1B5E20;
        text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
    }
    
    .btn-theme-primary {
        background-color: #1B5E20;
        border-color: #1B5E20;
        color: white;
    }
    .btn-theme-primary:hover {
        background-color: #2E7D32;
        border-color: #2E7D32;
        color: white;
    }

    /* --- Enhanced Card Styles (Glassmorphism) --- */
    .card {
        background: rgba(255, 255, 255, 0.3);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 8px 24px 0 rgba(0,0,0,0.1);
        transition: all 0.3s ease-in-out;
    }

    .card:hover {
        transform: translateY(-8px);
        box-shadow: 0 12px 32px 0 rgba(31, 38, 135, 0.15);
        border-color: rgba(255, 255, 255, 0.5);
    }
    
    .card-footer .btn {
        transition: all 0.2s ease-in-out;
    }
    .card-footer .btn:hover {
        transform: scale(1.03);
    }

    /* --- Engaging "No Farms" Placeholder --- */
    .no-farms-placeholder {
        background: rgba(255, 255, 255, 0.4);
        border: 2px dashed rgba(27, 94, 32, 0.3);
        border-radius: 1rem;
        padding: 3rem;
    }

    /* --- Modernized Modals --- */
    .modal-content {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.3);
    }
    .modal-header {
        border-bottom: 1px solid rgba(0,0,0,0.1);
    }
    .modal-backdrop.show {
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        background-color: rgba(0, 0, 0, 0.4);
    }

    #firstFarmBtn {
        box-shadow: 0 4px 12px rgba(0,0,0,0.8);
    }
    #firstFarmBtn:hover {
        background-color: #fff;
        color: #1B5E20;
        border: 1px solid #1B5E20;
    }

    /* --- Styles for the fullscreen controls overlay --- */
    #fullscreenControls { display: none; }
    #mapFullscreenArea:fullscreen { background-color: #fff; position: relative; }
    #mapFullscreenArea:fullscreen #addFarmMapWrapper { height: 100%; }
    #mapFullscreenArea:fullscreen #fullscreenControls {
        display: block;
        position: absolute;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 10;
        min-width: 300px;
        background-color: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(4px);
        border: 1px solid #ccc;
        box-shadow: 0 4px 12px rgba(0,0,0,0.6);
    }
    #mapFullscreenArea:fullscreen #addFarmMap { height: 100% !important; }

    /* Style for the farm card map when it is in fullscreen */
    .map-container-fullscreenable:fullscreen {
        background-color: transparent;
        position: relative; /* Needed for child absolute positioning */
    }

    /* Styles for the farm name overlay in fullscreen */
    .fullscreen-farm-name {
        display: none;
        position: absolute;
        top: 15px; left: 50%;
        transform: translateX(-50%);
        z-index: 10;
        background-color: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(4px);
        padding: 8px 15px;
        border-radius: 8px;
        border: 1px solid #ccc;
        box-shadow: 0 2px 8px rgba(0,0,0,0.4);
        font-size: 1.2rem;
        font-weight: 500;
        color: #333;
    }

    #addfarmbtn {
        box-shadow: 0 4px 12px rgba(0,0,0,0.8);
    }

    #addfarmbtn:hover {
        background-color: #fff;
        color: #1B5E20;
        border: 1px solid #1B5E20;
    }

    #getAdvisoryBtn {
         box-shadow: 0 4px 12px rgba(0,0,0,0.8);
    }

    #getAdvisoryBtn:hover {
        background-color: #fff;
        color: #1B5E20;
        border: 1px solid #1B5E20;
    }

    #cancelBtn {
        box-shadow: 0 4px 12px rgba(0,0,0,0.8);
    }
    #cancelBtn:hover {
        background-color: #fff;
        color: #212121;
        border: 1px solid #212121;
    }
        
    .map-container-fullscreenable:fullscreen .fullscreen-farm-name { display: block; }
    
    /* --- Custom OpenLayers Zoom Control Styles --- */
    .ol-zoom { top: 10px; left: 10px; background: none; padding: 0; }
    .ol-zoom button {
        background-color: rgba(255, 255, 255, 0.2);
        backdrop-filter: blur(3px); -webkit-backdrop-filter: blur(3px);
        color: #333; border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.6);
        font-size: 0; width: 34px; height: 34px; display: flex;
        align-items: center; justify-content: center; cursor: pointer;
        transition: all 0.2s ease-in-out;
    }
    .ol-zoom button:hover {
        background-color: rgba(27, 94, 32, 0.8);
        transform: scale(1.05); color: white;
    }
    .ol-zoom button:focus { outline: none; box-shadow: 0 0 0 0.2rem rgba(27, 94, 32, 0.25); }
    .ol-zoom-in { border-radius: 8px 8px 0 0; }
    .ol-zoom-out { border-radius: 0 0 8px 8px; border-top: none; }
    .ol-zoom button::before { font-family: "Font Awesome 5 Free"; font-weight: 900; font-size: 1rem; }
    .ol-zoom-in::before { content: "\f067"; }
    .ol-zoom-out::before { content: "\f068"; }
    
    /* --- NEW/MODIFIED: Dashboard-style Map Controls --- */
    .map-controls {
        position: absolute;
        top: 0.8rem;
        right: 0.8rem;
        z-index: 5;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    .map-control-btn {
        background-color: white;
        color: #1B5E20;
        border: 1px solid rgba(0,0,0,0.2);
        border-radius: 4px;
        width: 36px;
        height: 36px;
        font-size: 1.1rem;
        cursor: pointer;
        transition: all 0.2s ease-in-out;
        box-shadow: 0 2px 5px rgba(0,0,0,0.15);
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .map-control-btn:hover { background-color: #f0f0f0; }
    .map-control-btn.active {
        background-color: #1B5E20;
        color: white;
        border-color: #1B5E20;
    }
</style>

<div class="container py-4">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="main-title">{{ _('My Farms') }}</h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <button type="button" class="btn btn-sm btn-theme-primary" id="addfarmbtn" data-bs-toggle="modal" data-bs-target="#addFarmModal">
                <i class="fas fa-plus me-1"></i> {{ _('Add Farm') }}
            </button>
        </div>
    </div>

    {% if farms %}
        <div class="row row-cols-1 row-cols-md-2 g-4 mb-4">
            {% for farm in farms %}
                <div class="col farm-card" id="farm-card-{{ farm.id }}"
                     data-farm-id="{{ farm.id }}"
                     data-lat="{{ farm.latitude }}"
                     data-lon="{{ farm.longitude }}"
                     data-geojson="{{ farm.area_geojson | tojson }}">
                    <div class="card h-100">
                        <div class="card-img-top map-container-fullscreenable position-relative" style="height: 200px; border-radius: 1rem 1rem 0 0;">
                            <div id="farmMap{{ farm.id }}" style="height: 100%; width: 100%;"></div>
                            <div class="fullscreen-farm-name">{{ farm.name }}</div>
                            <div class="map-controls">
                                <button type="button" class="map-control-btn map-view-btn active" data-view-type="map" title="{{ _('Map View') }}"><i class="fas fa-map"></i></button>
                                <button type="button" class="map-control-btn map-view-btn" data-view-type="satellite" title="{{ _('Satellite View') }}"><i class="fas fa-satellite"></i></button>
                                <button type="button" class="map-control-btn map-view-btn" data-view-type="hybrid" title="{{ _('Hybrid View') }}"><i class="fas fa-layer-group"></i></button>
                                <button type="button" class="map-control-btn view-fullscreen-btn" title="{{ _('View Fullscreen') }}"><i class="fas fa-expand"></i></button>
                            </div>
                        </div>
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">{{ farm.name }}</h5>
                            <p class="card-text text-muted small">
                                <i class="fas fa-map-marker-alt me-1"></i> {{ farm.location }}
                            </p>
                            <div class="mt-auto">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div>
                                        <span class="badge bg-primary me-1">
                                            <i class="fas fa-map-pin me-1"></i> {{ "%.4f"|format(farm.latitude) }}, {{ "%.4f"|format(farm.longitude) }}
                                        </span>
                                        {% if farm.area_hectares %}
                                        <span class="badge bg-success me-1">
                                            <i class="fas fa-ruler-combined me-1"></i> {{ "%.2f"|format(farm.area_hectares) }} ha
                                        </span>
                                        {% endif %}
                                    </div>
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteFarm('{{ farm.id }}')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer bg-transparent border-top-0">
                            <a href="#" id="getAdvisoryBtn" class="btn btn-theme-primary w-100" data-bs-toggle="modal" data-bs-target="#getAdvisoryModal" data-farm-id="{{ farm.id }}">
                                <i class="fas fa-robot me-1"></i> {{ _('Get Advisory') }}
                            </a>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="text-center py-5 my-5 no-farms-placeholder">
            <i class="fas fa-tractor fa-4x mb-4" style="color: #1B5E20;"></i>
            <h3>{{ _('No Farms Added Yet') }}</h3>
            <p class="text-muted mb-4">{{ _('Get started by adding your first farm to receive personalized advisories.') }}</p>
            <button type="button" class="btn btn-theme-primary" data-bs-toggle="modal" data-bs-target="#addFarmModal" id="firstFarmBtn">
                <i class="fas fa-plus me-1"></i> {{ _('Add Your First Farm') }}
            </button>
        </div>
    {% endif %}
</div>

<div class="modal fade" id="addFarmModal" tabindex="-1" aria-labelledby="addFarmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addFarmModalLabel">{{ _('Add New Farm') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addFarmForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="farmName" class="form-label">{{ _('Farm Name') }}</label>
                        <input type="text" class="form-control" id="farmName" name="name" required>
                    </div>
                    
                    <div id="formControlsContainer">
                        <div class="mb-3">
                            <label for="farmLocation" class="form-label">{{ _('Location') }}</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="farmLocation" name="location" placeholder="{{ _('Search for a location...') }}" required>
                            </div>
                            <div class="form-text">{{ _('Search for an address, then draw your farm boundary on the map below.') }}</div>
                        </div>
                        <p class="text-muted">
                            <strong>{{ _('Estimated Area') }}:</strong>
                            <span id="farmAreaDisplay" class="fw-bold">0.00</span> Hectares
                        </p>
                    </div>

                    <div id="mapFullscreenArea">
                        <div id="fullscreenControls" class="p-3 rounded"></div>
                        <div class="position-relative mb-3" id="addFarmMapWrapper">
                            <div id="addFarmMap" style="height: 300px;" class="rounded border"></div>
                            <div class="map-controls">
                                <button type="button" class="map-control-btn map-view-btn active" data-view-type="map" title="{{ _('Map View') }}"><i class="fas fa-map"></i></button>
                                <button type="button" class="map-control-btn map-view-btn" data-view-type="satellite" title="{{ _('Satellite View') }}"><i class="fas fa-satellite"></i></button>
                                <button type="button" class="map-control-btn map-view-btn" data-view-type="hybrid" title="{{ _('Hybrid View') }}"><i class="fas fa-layer-group"></i></button>
                                <button type="button" id="fullscreenBtn" class="map-control-btn" title="Toggle Fullscreen"><i class="fas fa-expand"></i></button>
                            </div>
                        </div>
                    </div>

                    <input type="hidden" id="latitude" name="latitude">
                    <input type="hidden" id="longitude" name="longitude">
                    <input type="hidden" id="areaHectares" name="area_hectares">
                    <input type="hidden" id="areaGeoJSON" name="area_geojson">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancelBtn">{{ _('Cancel') }}</button>
                    <button type="submit" class="btn btn-theme-primary" id="addfarmbtn">{{ _('Add Farm') }}</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="getAdvisoryModal" tabindex="-1" aria-labelledby="getAdvisoryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="getAdvisoryModalLabel">{{ _('Get Farm Advisory') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="advisoryForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" id="selectedFarmId" name="farm_id">
                <div class="modal-body">
                    
                    <div class="mb-3">
                        <label for="cropType" class="form-label">{{ _('Crop Type') }}</label>
                        <select class="form-select" id="cropType" name="crop_type" required>
                            <option value="" selected disabled>{{ _('Select a crop...') }}</option>
                            {% for value, text in crop_options %}<option value="{{ value }}">{{ text }}</option>{% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="soilType" class="form-label">{{ _('Soil Type') }}</label>
                        <select class="form-select" id="soilType" name="soil_type" required>
                            <option value="" selected disabled>{{ _('Select soil type') }}</option>
                            {% for value, text in soil_types %}<option value="{{ value }}">{{ text }}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="cropStage" class="form-label">{{ _('Crop Growth Stage') }}</label>
                        <select class="form-select" id="cropStage" name="crop_stage" required>
                            <option value="" selected disabled>{{ _('Select growth stage') }}</option>
                            {% for value, text in crop_stages %}<option value="{{ value }}">{{ text }}</option>{% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancelBtn">{{ _('Close') }}</button>
                    <button type="submit" class="btn btn-theme-primary" id="getAdvisoryBtn">{{ _('Get Advisory') }}</button>
                </div>
            </form>
        </div>
    </div>
</div>
<div class="modal fade" id="advisoryResultModal" tabindex="-1" aria-labelledby="advisoryResultModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content" style="background-color: rgb(219, 255, 225, 0.8); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5); border: 1px solid #2E7D32;">
            <div class="modal-body p-4" id="advisoryResultBody">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="firstFarmBtn">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block extra_js %}
{{ super() }}
<script async defer src="https://maps.googleapis.com/maps/api/js?key={{ google_maps_api_key }}"></script>

<script>
// --- Global Helper Functions ---
const csrfToken = document.querySelector('meta[name="csrf-token"]') ? document.querySelector('meta[name="csrf-token"]').content : null;
if (!csrfToken) console.error('CSRF Token not found. API calls may fail.');

function debounce(func, delay) {
    let timeout;
    return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), delay);
    };
}

// --- Main DOMContentLoaded Event Listener ---
document.addEventListener('DOMContentLoaded', function() {
    
    const farmMaps = {};

    // --- Farm card map initialization ---
    document.querySelectorAll('.farm-card').forEach(card => {
        const farmId = card.dataset.farmId;
        const lat = parseFloat(card.dataset.lat);
        const lon = parseFloat(card.dataset.lon);
        const geojsonStr = card.dataset.geojson;
        if (isNaN(lat) || isNaN(lon)) return;
        const vectorSource = new ol.source.Vector();
        
        let feature;
        if (geojsonStr && geojsonStr !== 'null' && geojsonStr.length > 2) {
            try {
                feature = new ol.format.GeoJSON().readFeature(JSON.parse(geojsonStr), {
                    dataProjection: 'EPSG:4326',
                    featureProjection: 'EPSG:3857'
                });
                feature.setStyle(new ol.style.Style({
                    stroke: new ol.style.Stroke({ color: 'rgba(27, 94, 32, 1.0)', width: 2.5 }),
                    fill: new ol.style.Fill({ color: 'rgba(27, 94, 32, 0.4)' })
                }));
            } catch (e) { feature = null; }
        }
        if (!feature) {
            const farmLocation = ol.proj.fromLonLat([lon, lat]);
            feature = new ol.Feature({ geometry: new ol.geom.Point(farmLocation) });
            feature.setStyle(new ol.style.Style({
                image: new ol.style.Icon({
                    anchor: [0.5, 1],
                    src: 'https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@master/img/marker-icon-2x-green.png',
                    scale: 0.4
                })
            }));
        }
        vectorSource.addFeature(feature);
        
        const osmLayer = new ol.layer.Tile({ source: new ol.source.OSM() });
        const satelliteLayer = new ol.layer.Tile({
            source: new ol.source.XYZ({
                url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                maxZoom: 19
            }),
            visible: false
        });
        const hybridLayer = new ol.layer.Tile({
            source: new ol.source.XYZ({
                url: 'https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',
                maxZoom: 20
            }),
            visible: false
        });

        const map = new ol.Map({
            target: `farmMap${farmId}`,
            layers: [osmLayer, satelliteLayer, hybridLayer, new ol.layer.Vector({ source: vectorSource })],
            controls: [], 
            interactions: []
        });

        farmMaps[farmId] = { map, osmLayer, satelliteLayer, hybridLayer };

        map.once('postrender', function() {
            map.getView().fit(vectorSource.getExtent(), { 
                padding: [20, 20, 20, 20],
                maxZoom: 16,
                duration: 500
            });
        });
    });
    
    // --- CORRECTED: Fullscreen Button Logic for Farm Cards ---
    document.querySelectorAll('.view-fullscreen-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const mapContainer = this.closest('.card').querySelector('.map-container-fullscreenable');
            if (!mapContainer) return;

            if (!document.fullscreenElement) {
                mapContainer.requestFullscreen().catch(err => {
                    alert(`Error attempting to enable full-screen mode: ${err.message}`);
                });
            } else {
                document.exitFullscreen();
            }
        });
    });

    // --- "Add Farm" Modal Logic ---
    const addFarmModal = document.getElementById('addFarmModal');
    let addFarmMap, drawInteraction, addFarmVectorSource, addFarmOsmLayer, addFarmSatelliteLayer, addFarmHybridLayer;

    addFarmModal.addEventListener('shown.bs.modal', function() {
        if (!addFarmMap) {
            const indiaCenter = ol.proj.fromLonLat([78.9629, 20.5937]);
            addFarmVectorSource = new ol.source.Vector();
            
            addFarmOsmLayer = new ol.layer.Tile({ source: new ol.source.OSM() });
            addFarmSatelliteLayer = new ol.layer.Tile({
                source: new ol.source.XYZ({
                    url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                    maxZoom: 19
                }),
                visible: false
            });
            addFarmHybridLayer = new ol.layer.Tile({
                source: new ol.source.XYZ({
                    url: 'https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',
                    maxZoom: 20
                }),
                visible: false
            });

            addFarmMap = new ol.Map({
                target: 'addFarmMap',
                layers: [ addFarmOsmLayer, addFarmSatelliteLayer, addFarmHybridLayer, new ol.layer.Vector({ source: addFarmVectorSource }) ],
                view: new ol.View({ center: indiaCenter, zoom: 5 })
            });
            drawInteraction = new ol.interaction.Draw({ source: addFarmVectorSource, type: 'Polygon' });
            addFarmMap.addInteraction(drawInteraction);
            drawInteraction.on('drawend', function(event) {
                addFarmVectorSource.clear();
                const polygon = event.feature.getGeometry();
                const areaHectares = ol.sphere.getArea(polygon) / 10000;
                document.getElementById('farmAreaDisplay').textContent = areaHectares.toFixed(2);
                const [lon, lat] = ol.proj.toLonLat(ol.extent.getCenter(polygon.getExtent()));
                document.getElementById('latitude').value = lat.toFixed(6);
                document.getElementById('longitude').value = lon.toFixed(6);
                document.getElementById('areaHectares').value = areaHectares.toFixed(2);
                document.getElementById('areaGeoJSON').value = new ol.format.GeoJSON().writeFeature(event.feature, {
                    dataProjection: 'EPSG:4326',
                    featureProjection: 'EPSG:3857'
                });
            });
            document.getElementById('farmLocation').addEventListener('keyup', debounce(geocodeLocation, 500));
        }
        addFarmMap.updateSize();
    });

    function geocodeLocation() {
        const query = document.getElementById('farmLocation').value;
        if (!query || query.trim().length < 3) return;
        fetch(`/api/geocode?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                if (data.results && data.results.length > 0) {
                    const { lat, lon } = data.results[0];
                    if (addFarmMap) {
                        addFarmMap.getView().animate({
                            center: ol.proj.fromLonLat([lon, lat]),
                            zoom: 14,
                            duration: 1000
                        });
                    }
                }
            })
            .catch(error => console.error('Geocoding error:', error));
    }
    
    // --- Universal Map View Switcher Logic ---
    document.addEventListener('click', function(e) {
        const viewBtn = e.target.closest('.map-view-btn');
        if (!viewBtn) return;

        const viewType = viewBtn.dataset.viewType;
        const mapWrapper = viewBtn.closest('.position-relative');
        const olMapDiv = mapWrapper.querySelector('[id^="farmMap"], [id="addFarmMap"]');
        
        let mapInstance, osmLayer, satelliteLayer, hybridLayer;

        if (olMapDiv.id === 'addFarmMap') {
            mapInstance = addFarmMap;
            osmLayer = addFarmOsmLayer;
            satelliteLayer = addFarmSatelliteLayer;
            hybridLayer = addFarmHybridLayer;
        } else {
            const card = viewBtn.closest('.farm-card');
            const farmId = card.dataset.farmId;
            const mapData = farmMaps[farmId];
            mapInstance = mapData.map;
            osmLayer = mapData.osmLayer;
            satelliteLayer = mapData.satelliteLayer;
            hybridLayer = mapData.hybridLayer;
        }

        const controlsContainer = viewBtn.closest('.map-controls');
        controlsContainer.querySelectorAll('.map-view-btn').forEach(btn => btn.classList.remove('active'));
        viewBtn.classList.add('active');

        osmLayer.setVisible(viewType === 'map');
        satelliteLayer.setVisible(viewType === 'satellite');
        hybridLayer.setVisible(viewType === 'hybrid');
        
        if (mapInstance) {
            mapInstance.updateSize();
        }
    });

    // --- Fullscreen Logic for "Add Farm" Modal ---
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    if (fullscreenBtn) {
        fullscreenBtn.addEventListener('click', function() {
            const fullscreenArea = document.getElementById('mapFullscreenArea');
            if (!document.fullscreenElement) {
                fullscreenArea.requestFullscreen().catch(err => {
                    alert(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
                });
            } else {
                document.exitFullscreen();
            }
        });
    }

    // --- CORRECTED: Universal Fullscreen Change Handler ---
    document.addEventListener('fullscreenchange', () => {
        const fullscreenElement = document.fullscreenElement;
        
        // Reset all fullscreen button icons to 'expand' first
        document.querySelectorAll('.view-fullscreen-btn i, #fullscreenBtn i').forEach(iconEl => {
            if (iconEl) {
                iconEl.classList.remove('fa-compress');
                iconEl.classList.add('fa-expand');
            }
        });
        
        // If an element is in fullscreen, find its button and set the icon to 'compress'
        if (fullscreenElement) {
            const buttonIcon = fullscreenElement.querySelector('.view-fullscreen-btn i, #fullscreenBtn i');
            if (buttonIcon) {
                buttonIcon.classList.remove('fa-expand');
                buttonIcon.classList.add('fa-compress');
            }
        }
        
        // Handle control repositioning specifically for the "Add Farm" modal
        const fullscreenArea = document.getElementById('mapFullscreenArea');
        if (fullscreenArea) {
            const formControlsContainer = document.getElementById('formControlsContainer');
            const fullscreenControlsContainer = document.getElementById('fullscreenControls');
            const farmLocationGroup = document.getElementById('farmLocation')?.closest('.mb-3');
            const farmAreaGroup = document.getElementById('farmAreaDisplay')?.closest('p');
            
            if (fullscreenElement === fullscreenArea) {
                if (farmLocationGroup) fullscreenControlsContainer.appendChild(farmLocationGroup);
                if (farmAreaGroup) fullscreenControlsContainer.appendChild(farmAreaGroup);
            } else {
                if (formControlsContainer && farmLocationGroup && fullscreenControlsContainer.contains(farmLocationGroup)) {
                    formControlsContainer.insertBefore(farmLocationGroup, formControlsContainer.children[0]);
                    if (farmAreaGroup) formControlsContainer.insertBefore(farmAreaGroup, formControlsContainer.children[1]);
                }
            }
        }
        
        // Universal map update logic
        setTimeout(() => {
            if (addFarmMap) addFarmMap.updateSize();
            Object.values(farmMaps).forEach(mapData => mapData.map.updateSize());
        }, 100);
    });


    // --- Form Submission and other logic ---
    document.getElementById('addFarmForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const submitBtn = this.querySelector('button[type="submit"]');
        
        if (!document.getElementById('latitude').value || !document.getElementById('longitude').value) {
            alert('Please draw your farm boundary on the map or search for a location to set a point.');
            return;
        }

        submitBtn.disabled = true;
        submitBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Saving...`;

        const farmData = {
            name: document.getElementById('farmName').value,
            location: document.getElementById('farmLocation').value,
            latitude: parseFloat(document.getElementById('latitude').value),
            longitude: parseFloat(document.getElementById('longitude').value),
            area_hectares: parseFloat(document.getElementById('areaHectares').value) || 0,
            area_geojson: document.getElementById('areaGeoJSON').value
        };

        fetch('/api/farms', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(farmData)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => { throw new Error(err.error || 'Failed to add farm.') });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                window.location.reload();
            }
        })
        .catch(error => {
            alert('Error: ' + error.message);
        })
        .finally(() => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = `{{ _('Add Farm') }}`;
        });
    });

    // --- Advisory Modal and Dynamic Display Logic ---
    const getAdvisoryModal = document.getElementById('getAdvisoryModal');
    if (getAdvisoryModal) {
        getAdvisoryModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            document.getElementById('selectedFarmId').value = button.getAttribute('data-farm-id');
        });
    }
    
    document.getElementById('advisoryForm')?.addEventListener('submit', function(e) {
        e.preventDefault();
        const submitBtn = this.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> {{ _('Generating...') }}`;

        const data = {
            farm_id: this.elements.farm_id.value,
            crop_type: this.elements.crop_type.value,
            soil_type: this.elements.soil_type.value,
            crop_stage: this.elements.crop_stage.value
        };

        fetch('/api/advisory', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.indexOf("application/json") !== -1) {
                return response.json();
            } else {
                return response.text().then(text => {
                    throw new Error("{{ _('Server did not return JSON. Please log in again.') }}");
                });
            }
        })
        .then(result => {
            if (result.success) {
                const formModal = bootstrap.Modal.getInstance(getAdvisoryModal);
                formModal.hide();

                const advisory = result.advisory;
                const advisoryResultBody = document.getElementById('advisoryResultBody');

                const now = new Date();
                
                const formattedDateTime = now.toLocaleString('{{ get_locale() }}', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit'
                });

                const priorityBadges = {
                    'Low': 'bg-info text-dark',
                    'Medium': 'bg-warning text-dark',
                    'High': 'bg-danger'
                };
                const badgeClass = priorityBadges[advisory.priority] || 'bg-secondary';

                let actionableHtml = '';
                const adviceItems = advisory.actionable_advice || {};
                if (Object.keys(adviceItems).length > 0) {
                    actionableHtml += `<h6 class="text-uppercase mt-4" style="font-size: 0.9rem; color: #333;">{{ _('Actionable Advice') }}</h6>`;
                    for (const [key, value] of Object.entries(adviceItems)) {
                        actionableHtml += `
                            <div class="mt-3">
                                <h6 class="d-block mb-1">${key}</h6>
                                <p class="mb-0 text-muted">${value.replace(/\*\*Alerts:\*\*/g, '<strong>{{ _("Alerts") }}:</strong>')}</p>
                            </div>
                        `;
                    }
                }

                const advisoryHtml = `
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div>
                            <h5 class="modal-title mb-1" style="color: #2E7D32;">${advisory.title}</h5>
                            <small class="text-muted">
                                {{ _('For Farm:') }} <strong>${advisory.farm_name}</strong> <br> 
                                {{ _('Issued on:') }} ${formattedDateTime}
                            </small>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>

                    <span class="badge rounded-pill ${badgeClass} mb-3">${advisory.priority_display}</span>

                    <hr class="mt-1">

                    <h6 style="font-size: 0.9rem; color: #333;">{{ _('Weather Outlook') }}</h6>
                    <p class="text-muted">${advisory.weather_outlook || '{{ _("No specific weather advisories at this time.") }}'}</p>

                    ${actionableHtml}
                `;
                
                advisoryResultBody.innerHTML = advisoryHtml;
                
                const resultModal = new bootstrap.Modal(document.getElementById('advisoryResultModal'));
                resultModal.show();
            } else {
                 alert(result.error || "{{ _('An unknown error occurred.') }}");
            }
        })
        .catch(error => alert('Error: ' + error.message))
        .finally(() => {
            submitBtn.disabled = false;
            submitBtn.innerHTML = `{{ _('Get Advisory') }}`;
        });
    });
});

// --- Global Delete Farm Function ---
function deleteFarm(farmId) {
    if (!csrfToken) return alert("{{ _('Security token missing.') }}");
    if (confirm("{{ _('Are you sure you want to delete this farm? This action cannot be undone.') }}")) {
        fetch(`/api/farms/${farmId}`, {
            method: 'DELETE',
            headers: { 'X-CSRFToken': csrfToken }
        })
        .then(response => {
            if (!response.ok) throw new Error("{{ _('Failed to delete farm.') }}");
            window.location.reload();
        })
        .catch(error => alert("{{ _('Error deleting farm.') }}"));
    }
}
</script>
{% endblock %}