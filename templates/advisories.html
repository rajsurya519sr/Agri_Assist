{% extends "base.html" %}

{% block title %}{{ _('Advisories') }} - {{ _('FarmAdvisor') }}{% endblock %}

{% block content %}
<style>
    /* --- Page Layout & Theme --- */
    body {
        background-image: linear-gradient(to right, white, #1B5E20);
        background-attachment: fixed;
    }

    .main-title {
        color: #1B5E20;
        text-shadow: 1px 1px 3px rgba(0,0,0,0.2);
    }
    
    .btn-theme-primary {
        background-color: #1B5E20;
        border-color: #1B5E20;
        color: white;
    }
    .btn-theme-primary:hover {
        background-color: #2E7D32;
        border-color: #2E7D32;
        color: white;
    }

    /* --- Enhanced Advisory Card Styles --- */
    .advisory-card {
        background: rgba(255, 255, 255, 0.3);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: 0 8px 24px 0 rgba(0,0,0,0.1);
        transition: all 0.3s ease-in-out;
        border-radius: 0.75rem;
    }

    .advisory-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 12px 32px 0 rgba(31, 38, 135, 0.15);
        border-color: rgba(255, 255, 255, 0.5);
    }
    
    .advisory-card.unread {
        border-left: 4px solid #198754; /* Theme green for unread items */
    }
    
    .advisory-card .card-title {
        color: #1B5E20;
    }
    
    /* --- Engaging "No Advisories" Placeholder --- */
    .no-advisories-placeholder {
        background: rgba(255, 255, 255, 0.4);
        border: 2px dashed rgba(27, 94, 32, 0.3);
        border-radius: 1rem;
        padding: 3rem;
    }

    /* --- Modernized Modals --- */
    .modal-content {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(15px);
        -webkit-backdrop-filter: blur(15px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 1rem;
    }
    .modal-header {
        border-bottom: 1px solid rgba(0,0,0,0.1);
    }
    .modal-backdrop.show {
        backdrop-filter: blur(5px);
        -webkit-backdrop-filter: blur(5px);
        background-color: rgba(0, 0, 0, 0.4);
    }

    /* --- Header & Bulk Actions --- */
    #advisory-list-header {
        background: rgba(255, 255, 255, 0.2);
        border: 1px solid #1B5E20;
        border-radius: 0.5rem;
    }
    #filterBtn {
        background-color: #2c2b2b;
        border: 1px solid #2c2b2b;
        color: #ffffff;
        box-shadow: 0 4px 6px rgba(0,0,0,0.8);
    }
    #filterBtn:hover {
        background-color: #ffffff;
        border: 1px solid #2c2b2b;
        color: #2c2b2b;
    }
    #generateAdvisoryBtn, #applyFilters, #generateSubmitBtn{
        background-color: #1B5E20;
        border: 1px solid #1B5E20;
        color: white;
        box-shadow: 0 4px 6px rgba(0,0,0,0.8);
    }
    #generateAdvisoryBtn:hover, #applyFilters:hover, #generateSubmitBtn:hover {
        background-color: #ffffff;
        border: 1px solid #1B5E20;
        color: #1B5E20;
    }

    #cancelBtn {
        box-shadow: 0 4px 12px rgba(0,0,0,0.8);
    }
    #cancelBtn:hover {
        background-color: #fff;
        color: #212121;
        border: 1px solid #212121;
    }

    /* --- Checkbox Custom Green Checked State --- */
    .form-check-input:checked {
        background-color: #1B5E20 !important; /* Your desired green color */
        border-color: #1B5E20 !important;     /* Matching border color */
        cursor: pointer;
    }

    /* Ensure default border is still green when unchecked */
    .form-check-input {
        border-color: #1B5E20; /* Default border color for unchecked */
        cursor: pointer;
    }

    /* Optional: Keep the checkmark white for better contrast on green background */
    .form-check-input:checked[type="checkbox"] {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3e%3cpath fill='none' stroke='%23fff' stroke-linecap='round' stroke-linejoin='round' stroke-width='3' d='M6 10l3 3l6-6'/%3e%3c/svg%3e") !important;
    }
</style>

<div class="container py-4">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="main-title">{{ _('Farming Advisories') }}</h1>
        <div>
            <div class="btn-group me-2" id="bulk-actions" style="display: none;">
                <button type="button" class="btn btn-sm btn-outline-danger" id="deleteSelectedBtn">
                    <i class="fas fa-trash-alt me-1"></i> {{ _('Delete Selected') }}
                </button>
                <button type="button" class="btn btn-sm btn-danger" id="deleteAllBtn">
                    <i class="fas fa-exclamation-triangle me-1"></i> {{ _('Delete All') }}
                </button>
            </div>
            <button type="button" class="btn" id="filterBtn" data-bs-toggle="modal" data-bs-target="#filterModal">
                <i class="fas fa-filter me-1"></i> {{ _('Filter') }}
            </button>
            <button type="button" class="btn" id="generateAdvisoryBtn" data-bs-toggle="modal" data-bs-target="#generateAdvisoryModal">
                <i class="fas fa-magic me-1"></i> {{ _('Generate AI Advisory') }}
            </button>
        </div>
    </div>

    <div id="advisory-list">
        {% if advisories %}
            <div class="p-2 mb-3" id="advisory-list-header">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="selectAllCheckbox" title="{{ _('Select All') }}">
                    <label class="form-check-label small text-muted fw-bold" for="selectAllCheckbox">
                        {{ _('SELECT ALL') }}
                    </label>
                </div>
            </div>

            {% for advisory in advisories %}
                <div class="card advisory-card mb-3 {% if not advisory.is_read %}unread{% endif %}">
                    <div class="card-body">
                        <div class="d-flex w-100 justify-content-between">
                            <div class="d-flex align-items-center">
                                <input class="form-check-input advisory-checkbox mt-0 me-3" type="checkbox" value="{{ advisory.id }}">
                                <h5 class="card-title mb-0">{{ advisory.title }}</h5>
                            </div>
                            <small class="advisory-timestamp text-muted text-nowrap">
                                {{ advisory.created_at|format_datetime('medium') }}
                            </small>
                        </div>
                        <p class="mb-1 mt-2 text-muted" style="white-space: pre-wrap;">{{ advisory.content }}</p>
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <small class="text-muted">
                                <i class="fas fa-tractor me-1"></i> {{ advisory.farm.name }}
                                <span class="mx-2">•</span>
                                {% set priority_color = 'info' %}
                                {% if advisory.priority == 'High' %}{% set priority_color = 'danger' %}
                                {% elif advisory.priority == 'Medium' %}{% set priority_color = 'warning' %}
                                {% endif %}
                                <span class="badge bg-{{ priority_color }}">{{ _(advisory.priority) }}</span>
                            </small>
                            <div>
                                <button class="btn btn-sm btn-outline-secondary mark-read" style="background-color: #1B5E20; color: #ffffff; border: 1px solid #1B5E20;box-shadow: 0 4px 6px rgba(0,0,0,0.8);" data-id="{{ advisory.id }}" title="{{ _('Mark as read') if not advisory.is_read else _('Mark as unread') }}">
                                    <i class="fas fa-{{ 'envelope-open' if advisory.is_read else 'envelope' }}"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-danger delete-advisory" style="box-shadow: 0 4px 6px rgba(0,0,0,0.8);" data-id="{{ advisory.id }}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="text-center py-5 my-5 no-advisories-placeholder" id="no-advisories-placeholder">
                <i class="fas fa-inbox fa-4x mb-4" style="color: #1B5E20;"></i>
                <h3>{{ _('No Advisories Yet') }}</h3>
                <p class="text-muted mb-4">{{ _('Generate your first AI-powered advisory to get started.') }}</p>
                <button type="button" class="btn btn-theme-primary" data-bs-toggle="modal" data-bs-target="#generateAdvisoryModal" id="generateAdvisoryBtn">
                    <i class="fas fa-magic me-1"></i> {{ _('Generate AI Advisory') }}
                </button>
            </div>
        {% endif %}
    </div>
</div>

<div class="modal fade" id="generateAdvisoryModal" tabindex="-1" aria-labelledby="generateAdvisoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="generateAdvisoryModalLabel">{{ _('Generate AI Advisory') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted small">{{ _("Select a farm and provide crop details to get a tailored advisory based on current conditions.") }}</p>
                <form id="advisoryForm">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-3">
                        <label for="farm_id" class="form-label">{{ _('Farm') }}</label>
                        <select class="form-select" id="farm_id" name="farm_id" required>
                            <option value="" selected disabled>{{ _('Select a farm...') }}</option>
                            {% for farm in farms %}
                            <option value="{{ farm.id }}">{{ farm.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="crop_type" class="form-label">{{ _('Crop Type') }}</label>
                        <select class="form-select" id="crop_type" name="crop_type" required>
                            <option value="" selected disabled>{{ _('Select a crop...') }}</option>
                            {% for crop in crop_options %}<option value="{{ crop[0] }}">{{ crop[1] }}</option>{% endfor %}
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="crop_stage" class="form-label">{{ _('Crop Stage') }}</label>
                            <select class="form-select" id="crop_stage" name="crop_stage" required>
                                <option value="" selected disabled>{{ _('Select a stage...') }}</option>
                                {% for stage in crop_stages %}
                                <option value="{{ stage[0] }}">{{ stage[1] }}</option>
                                {% endfor %}
                            </select>
                        </div>
                         <div class="col-md-6 mb-3">
                            <label for="soil_type" class="form-label">{{ _('Soil Type') }}</label>
                            <select class="form-select" id="soil_type" name="soil_type" required>
                                <option value="" selected disabled>{{ _('Select a soil type...') }}</option>
                                {% for soil in soil_types %}
                                <option value="{{ soil[0] }}">{{ soil[1] }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancelBtn">{{ _('Cancel') }}</button>
                <button type="submit" form="advisoryForm" class="btn btn-theme-primary" id="generateSubmitBtn">{{ _('Generate') }}</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="filterModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ _('Filter Advisories') }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">{{ _('Farm') }}</label>
                    <select class="form-select" id="farmFilter">
                        <option value="">{{ _('All Farms') }}</option>
                        {% for farm in farms %}
                            <option value="{{ farm.id }}">{{ farm.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">{{ _('Status') }}</label>
                    <select class="form-select" id="statusFilter">
                        <option value="all">{{ _('All') }}</option>
                        <option value="read">{{ _('Read') }}</option>
                        <option value="unread">{{ _('Unread') }}</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">{{ _('Priority') }}</label>
                    <select class="form-select" id="priorityFilter">
                        <option value="">{{ _('All') }}</option>
                        <option value="high">{{ _('High') }}</option>
                        <option value="medium">{{ _('Medium') }}</option>
                        <option value="low">{{ _('Low') }}</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancelBtn">{{ _('Close') }}</button>
                <button type="button" class="btn btn-theme-primary" id="applyFilters">{{ _('Apply Filters') }}</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="advisoryResultModal" tabindex="-1" aria-labelledby="advisoryResultModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content" style="border: none;">
            <div class="modal-header text-white" style="background-color: #1B5E20;">
                <h5 class="modal-title" id="advisoryResultModalLabel"><i class="fas fa-robot me-2"></i>{{ _('Farm Advisory') }}</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="advisoryResultBody" style="background-color: rgba(240, 255, 243, 0.8); padding: 2rem;">
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ super() }}
<span id="delete-selected-confirm-message" style="display:none;">{{ _("Are you sure you want to delete {count} selected advisories?") }}</span>
<span id="delete-all-confirm-message" style="display:none;">{{ _("This action will permanently delete ALL of your advisories. This cannot be undone. Please type 'DELETE' to confirm.") }}</span>
<span id="delete-single-confirm-message" style="display:none;">{{ _("Are you sure you want to delete this advisory?") }}</span>
<span id="delete-cancelled-message" style="display:none;">{{ _("Deletion cancelled. You did not type 'DELETE'.") }}</span>
<span id="failed-delete-message" style="display:none;">{{ _("Failed to delete advisory.") }}</span>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // CSRF token may not be present if the user has no farms to generate from.
    const csrfTokenInput = document.querySelector('input[name="csrf_token"]');
    const csrfToken = csrfTokenInput ? csrfTokenInput.value : null;
    const advisoryForm = document.getElementById('advisoryForm');

    // --- ADVISORY GENERATION LOGIC ---
    if (advisoryForm) {
        advisoryForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const submitBtn = document.getElementById('generateSubmitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> {{ _('Generating...') }}`;

            const formData = {
                farm_id: document.getElementById('farm_id').value,
                crop_type: document.getElementById('crop_type').value,
                crop_stage: document.getElementById('crop_stage').value,
                soil_type: document.getElementById('soil_type').value,
            };

            fetch("{{ url_for('get_advisory') }}", {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify(formData)
            })
            .then(response => {
                if (response.ok) return response.json();
                return response.json().then(err => Promise.reject(err));
            })
            .then(data => {
                if (data.success && data.advisory) {
                    const formModalEl = document.getElementById('generateAdvisoryModal');
                    const formModal = bootstrap.Modal.getInstance(formModalEl);
                    if (formModal) formModal.hide();

                    const advisory = data.advisory;
                    document.getElementById('advisoryResultBody').innerHTML = `
                        <h5 class="mb-3">${advisory.title}</h5>
                        <p class="mb-0" style="white-space: pre-wrap;">${advisory.content}</p>
                    `;

                    const resultModalEl = document.getElementById('advisoryResultModal');
                    const resultModal = new bootstrap.Modal(resultModalEl);
                    resultModal.show();
                    
                    resultModalEl.addEventListener('hidden.bs.modal', () => addAdvisoryToDOM(advisory), { once: true });
                } else {
                    throw new Error('{{ _("Received an invalid response from the server.") }}');
                }
            })
            .catch(err => {
                console.error('Advisory Generation Error:', err);
                alert('{{ _("Failed to generate advisory:") }} ' + (err.error || err.message));
            })
            .finally(() => {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '{{ _("Generate") }}';
            });
        });

        document.getElementById('generateAdvisoryModal').addEventListener('hidden.bs.modal', function() {
            advisoryForm.reset();
        });
    }

    // --- FUNCTION TO ADD A NEW ADVISORY CARD TO THE PAGE ---
    function addAdvisoryToDOM(advisory) {
        const advisoryListContainer = document.getElementById('advisory-list');
        const noAdvisoriesPlaceholder = document.getElementById('no-advisories-placeholder');
        
        if (noAdvisoriesPlaceholder) {
            noAdvisoriesPlaceholder.remove();
            const headerHtml = `
                <div class="p-2 mb-3" id="advisory-list-header">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" value="" id="selectAllCheckbox" title="{{ _('Select All') }}" style="border: 1px solid #1B5E20;">
                        <label class="form-check-label small text-muted fw-bold" for="selectAllCheckbox">
                            {{ _('SELECT ALL') }}
                        </label>
                    </div>
                </div>`;
            advisoryListContainer.insertAdjacentHTML('afterbegin', headerHtml);
        }

        const priorityColors = { 'High': 'danger', 'Medium': 'warning', 'Low': 'info' };
        const priorityColor = priorityColors[advisory.priority] || 'secondary';

        const newAdvisoryHtml = `
        <div class="card advisory-card mb-3 unread" style="opacity: 0; transition: opacity 0.5s ease;">
            <div class="card-body" style="box-shadow: 0 4px 6px rgba(0,0,0,0.8);">
                <div class="d-flex w-100 justify-content-between">
                    <div class="d-flex align-items-center">
                        <input class="form-check-input advisory-checkbox mt-0 me-3" type="checkbox" value="${advisory.id}" style="background-color: #ffffff;border: 1px solid #1B5E20;">
                        <h5 class="card-title mb-0">${advisory.title}</h5>
                    </div>
                    <small class="advisory-timestamp text-muted text-nowrap">{{ _('Just now') }}</small>
                </div>
                <p class="mb-1 mt-2 text-muted" style="white-space: pre-wrap;">${advisory.content}</p>
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <small class="text-muted">
                        <i class="fas fa-tractor me-1"></i> ${advisory.farm.name}
                        <span class="mx-2">•</span>
                        <span class="badge bg-${priorityColor}">${advisory.priority}</span>
                    </small>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary mark-read" style="background-color: #1B5E20; color: #ffffff; border: 1px solid #1B5E20;box-shadow: 0 4px 6px rgba(0,0,0,0.8);" data-id="${advisory.id}" title="{{ _('Mark as read') }}">
                            <i class="fas fa-envelope"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-advisory" style="box-shadow: 0 4px 6px rgba(0,0,0,0.8);" data-id="${advisory.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>`;

        const listHeader = advisoryListContainer.querySelector('#advisory-list-header');
        listHeader.insertAdjacentHTML('afterend', newAdvisoryHtml);

        const newElement = listHeader.nextElementSibling;
        setTimeout(() => { newElement.style.opacity = 1; }, 50);
    }

    // --- BULK ACTIONS & INTERACTIVITY ---
    function updateBulkActionUI() {
        const advisoryList = document.getElementById('advisory-list');
        if (!advisoryList) return;
        const anyChecked = advisoryList.querySelectorAll('.advisory-checkbox:checked').length > 0;
        document.getElementById('bulk-actions').style.display = anyChecked ? 'inline-block' : 'none';
    }

    // Delegated listener for all clicks within the document
    document.addEventListener('click', function(e) {
        // Mark Read/Unread Button
        const markReadButton = e.target.closest('.mark-read');
        if (markReadButton) {
            const advisoryId = markReadButton.dataset.id;
            const icon = markReadButton.querySelector('i');
            const isRead = icon.classList.contains('fa-envelope-open');

            fetch(`/api/advisories/${advisoryId}/read`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ is_read: !isRead })
            }).then(response => response.json())
              .then(data => {
                  if (data.success) {
                      const item = markReadButton.closest('.advisory-card');
                      if (data.is_read) {
                          icon.classList.replace('fa-envelope', 'fa-envelope-open');
                          markReadButton.title = '{{ _("Mark as unread") }}';
                          item.classList.remove('unread');
                      } else {
                          icon.classList.replace('fa-envelope-open', 'fa-envelope');
                          markReadButton.title = '{{ _("Mark as read") }}';
                          item.classList.add('unread');
                      }
                  }
              }).catch(console.error);
        }

        // Single Delete Button
        const deleteButton = e.target.closest('.delete-advisory');
        if (deleteButton) {
            if (!confirm(document.getElementById('delete-single-confirm-message').textContent)) return;
            
            const advisoryId = deleteButton.dataset.id;
            const item = deleteButton.closest('.advisory-card');
            
            fetch(`/api/advisories/${advisoryId}`, {
                method: 'DELETE',
                headers: { 'X-CSRFToken': csrfToken }
            })
            .then(response => {
                if (response.ok) {
                    item.style.transition = 'opacity 0.5s ease';
                    item.style.opacity = '0';
                    setTimeout(() => {
                        item.remove();
                        // If it was the last advisory, reload to show the placeholder
                        if (!document.querySelector('.advisory-card')) {
                            window.location.reload();
                        }
                    }, 500);
                } else {
                    alert(document.getElementById('failed-delete-message').textContent);
                }
            }).catch(console.error);
        }
    });

    // Delegated listener for checkbox changes
    document.addEventListener('change', e => {
        const advisoryList = document.getElementById('advisory-list');
        if (!advisoryList) return;

        // Select/Deselect All
        if (e.target.matches('#selectAllCheckbox')) {
            advisoryList.querySelectorAll('.advisory-checkbox').forEach(checkbox => {
                checkbox.checked = e.target.checked;
            });
        }
        
        // Update UI if any checkbox is changed
        if (e.target.matches('.advisory-checkbox, #selectAllCheckbox')) {
            const allCheckboxes = advisoryList.querySelectorAll('.advisory-checkbox');
            const checkedCheckboxes = advisoryList.querySelectorAll('.advisory-checkbox:checked');
            const selectAll = advisoryList.querySelector('#selectAllCheckbox');
            
            if (selectAll) {
                selectAll.checked = allCheckboxes.length > 0 && checkedCheckboxes.length === allCheckboxes.length;
            }
            updateBulkActionUI();
        }
    });

    // --- BUTTON-SPECIFIC LISTENERS ---
    document.getElementById('deleteSelectedBtn')?.addEventListener('click', function() {
        const advisoryList = document.getElementById('advisory-list');
        if (!advisoryList) return;
        const selectedIds = Array.from(advisoryList.querySelectorAll('.advisory-checkbox:checked')).map(cb => cb.value);
        if (selectedIds.length === 0) return;

        const messageTemplate = document.getElementById('delete-selected-confirm-message').textContent;
        const confirmationMessage = messageTemplate.replace('{count}', selectedIds.length);
        
        if (confirm(confirmationMessage)) {
            fetch("{{ url_for('bulk_delete_advisories') }}", {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ ids: selectedIds })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert('{{ _("Error:") }} ' + (data.error || '{{ _("Could not delete advisories.") }}'));
                }
            }).catch(err => console.error(err));
        }
    });

    document.getElementById('deleteAllBtn')?.addEventListener('click', function() {
        const confirmationMessage = document.getElementById('delete-all-confirm-message').textContent;
        const confirmation = prompt(confirmationMessage);
        
        if (confirmation === 'DELETE') {
             fetch("{{ url_for('delete_all_advisories') }}", {
                method: 'DELETE',
                headers: { 'X-CSRFToken': csrfToken }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    window.location.reload();
                } else {
                    alert('{{ _("Error:") }} ' + (data.error || '{{ _("Could not delete advisories.") }}'));
                }
            }).catch(err => console.error(err));
        } else if (confirmation !== null) {
            alert(document.getElementById('delete-cancelled-message').textContent);
        }
    });

    document.getElementById('applyFilters')?.addEventListener('click', function() {
        const farmId = document.getElementById('farmFilter').value;
        const status = document.getElementById('statusFilter').value;
        const priority = document.getElementById('priorityFilter').value;
        
        const params = new URLSearchParams(window.location.search);
        if (farmId) params.set('farm_id', farmId); else params.delete('farm_id');
        if (status && status !== 'all') params.set('status', status); else params.delete('status');
        if (priority) params.set('priority', priority); else params.delete('priority');
        
        window.location.search = params.toString();
    });
});
</script>
{% endblock %}